pipeline {

    agent any

    environment {
        GHCR_TOKEN = credentials('GHCR_TOKEN')
    }

    tools {
        nodejs 'nodejs'
    }

    stages {
        stage("Install Dependencies") {
            steps {
                dir("bdlist-backend/") {
                    echo 'Installing dependencies...'
                    sh 'pnpm i'
                }
            }
        }

        stage ("Transpile TypeScript to JavaScript") {
            steps {
                dir("bdlist-backend/") {
                    echo 'Transpiling TypeScript to JavaScript...'
                    sh 'pnpm build'
                }
            }
        }

        stage ("Multi-platform Dockerize API and push to ghcr.io") {
            steps {
                dir("bdlist-backend/") {
                    echo 'Grabbing version number for Docker tag...'
                    script {
                        RAW = sh(script: "jq '.version' package.json", returnStdout: true).trim()
                        TAG = sh(script: "sed -e 's/^\"//' -e 's/\"$//' <<<\$RAW", returnStdout: true).trim()
                    }
                    echo 'Authenticating Docker with ghcr.io...'
                    sh 'docker login ghcr.io -u PScoriae -p $GHCR_TOKEN'

                    echo 'Building and pushing multi-platform image...'
                    sh 'docker buildx build --push --platform linux/amd64,linux/arm64 -t ghcr.io/shuttleday/api:${TAG} . --builder=build-container' 
                }
            }
        }  
    }

    post {
        cleanup {
            echo 'Deleting dangling images...'
            sh 'docker system prune -f'
            echo 'Success!'
        }
    }
}