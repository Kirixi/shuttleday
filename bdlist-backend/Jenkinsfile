pipeline {

    agent any

    environment {
        GHCR_TOKEN     = credentials('GHCR_TOKEN')
    }

    tools {
        nodejs 'nodejs'
    }
    stages {
        stage("Install Dependencies") {
            steps {
                dir("bdlist-backend/") {
                    sh 'pnpm i'
                }
            }
        }
        stage ("Transpile TypeScript to JavaScript") {
            steps {
                dir("bdlist-backend/") {
                    sh 'pnpm build'
                }
            }
        }

        stage ("Dockerize API") {
            steps {
                dir("bdlist-backend/") {
                    sh 'docker build -t ghcr.io/shuttleday/api:latest .' 
                }
            }
        }  

        stage ("Push image to ghcr.io") {
            steps {
                dir("bdlist-backend/") {
                    sh 'docker login ghcr.io -u PScoriae -p $GHCR_TOKEN'
                    sh 'docker push ghcr.io/shuttleday/api:latest' 
                }
            }
        }  
    }
    post {
        cleanup {
            sh 'docker system prune -f'
        }
    }
}