pipeline {

    agent any

    environment {
        GHCR_TOKEN     = credentials('GHCR_TOKEN')
    }

    tools {
        nodejs 'nodejs'
    }
    stages {
        stage("Install Dependencies") {
            steps {
                dir("bdlist-backend/") {
                    sh 'pnpm i'
                }
            }
        }
        stage ("Transpile TypeScript to JavaScript") {
            steps {
                dir("bdlist-backend/") {
                    sh 'pnpm build'
                }
            }
        }

        stage ("Multi-platform Dockerize API and push to ghcr.io") {
            steps {
                dir("bdlist-backend/") {
                    sh 'docker login ghcr.io -u PScoriae -p $GHCR_TOKEN'
                    sh 'docker buildx create --name build-container --driver=docker-container'
                    sh 'docker buildx build --push --platform linux/amd64,linux/arm64 -t ghcr.io/shuttleday/api:latest . --builder=build-container' 
                }
            }
        }  
    }
    post {
        cleanup {
            sh 'docker system prune -f'
        }
    }
}